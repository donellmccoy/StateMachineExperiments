@page "/formal-lod"

<PageTitle>Formal LOD Cases</PageTitle>

<div class="card">
    <h1>⚖️ Formal Line of Duty Cases</h1>
    <p>Manage formal LOD cases with comprehensive investigation and appeal processes.</p>
</div>

@if (isLoading)
{
    <div class="loading">
        <p>Loading...</p>
    </div>
}
else
{
    <div class="card">
        <h2>Create New Formal Case</h2>
        <div class="form-group">
            <label>Case Number</label>
            <input type="text" @bind="newCaseNumber" placeholder="Enter case number (e.g. FORMAL-LOD-2026-001)" />
        </div>
        <div class="form-group">
            <label>Member ID</label>
            <input type="text" @bind="newMemberId" placeholder="Enter member ID" />
        </div>
        <div class="form-group">
            <label>Member Name</label>
            <input type="text" @bind="newMemberName" placeholder="Enter member name" />
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" @bind="isDeathCase" />
                Death Case (Requires Expedited Processing)
            </label>
        </div>
        <button class="btn btn-success" @onclick="CreateNewCase">Create Formal Case</button>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @messageClass">
            @message
        </div>
    }

    @if (selectedCase != null)
    {
        <div class="card">
            <h2>Case: @selectedCase.CaseNumber</h2>
            <p><strong>Current State:</strong> <span class="state-badge state-progress">@selectedCase.CurrentState</span></p>
            <p><strong>Member:</strong> @selectedCase.MemberName (@selectedCase.MemberId)</p>
            <p><strong>Created:</strong> @selectedCase.CreatedDate.ToString("g")</p>
            @if (selectedCase.IsDeathCase)
            {
                <p><strong><span class="alert-danger">Death Case - Expedited Processing Required</span></strong></p>
            }

            <h3>Case Details</h3>
            <table>
                <tr><td><strong>Toxicology Required:</strong></td><td>@selectedCase.ToxicologyRequired</td></tr>
                <tr><td><strong>Toxicology Complete:</strong></td><td>@selectedCase.ToxicologyComplete</td></tr>
                <tr><td><strong>Appeal Filed:</strong></td><td>@selectedCase.AppealFiled</td></tr>
                <tr><td><strong>Investigating Officer:</strong></td><td>@selectedCase.InvestigatingOfficerName</td></tr>
            </table>

            <h3>Available Triggers</h3>
            @if (permittedTriggers.Any())
            {
                <div>
                    @foreach (var trigger in permittedTriggers)
                    {
                        <button class="btn" @onclick="() => FireTrigger(trigger)">@trigger</button>
                    }
                </div>
            }
            else
            {
                <p>No available actions in current state.</p>
            }

            <h3>Transition History</h3>
            @if (caseHistory.Any())
            {
                <table class="transition-history">
                    <thead>
                        <tr>
                            <th>From State</th>
                            <th>To State</th>
                            <th>Trigger</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var transition in caseHistory.OrderByDescending(t => t.Timestamp))
                        {
                            <tr>
                                <td>@transition.FromState</td>
                                <td>@transition.ToState</td>
                                <td>@transition.Trigger</td>
                                <td>@transition.Timestamp.ToString("g")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>No transitions yet.</p>
            }
        </div>
    }
}
