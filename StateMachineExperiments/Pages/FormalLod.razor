@page "/formal-lod"

<PageTitle>Formal LOD Cases</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenCard Variant="Variant.Outlined">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="gavel" IconStyle="IconStyle.Secondary" Style="font-size: 2rem;" />
            <RadzenStack Gap="0">
                <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" class="rz-mb-0">Formal Line of Duty Cases</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">Manage formal LOD cases with comprehensive investigation and appeal processes</RadzenText>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    @if (isLoading)
    {
        <RadzenCard>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" class="rz-p-4">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
                <RadzenText>Loading cases...</RadzenText>
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenCard Variant="Variant.Outlined">
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H2">
                    <RadzenIcon Icon="add_circle_outline" /> Create New Formal Case
                </RadzenText>
                
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="Case Number" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="newCaseNumber" Placeholder="e.g., FORMAL-LOD-2026-001" Style="width: 100%;" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="Member ID" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="newMemberId" Placeholder="Enter member ID" Style="width: 100%;" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="Member Name" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="newMemberName" Placeholder="Enter member name" Style="width: 100%;" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                
                <RadzenCheckBox @bind-Value="isDeathCase" Name="isDeathCase" />
                <RadzenLabel Text="Death Case (Requires Expedited Processing)" Component="isDeathCase" Style="margin-left: 8px; cursor: pointer;" />
                
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Icon="add" Text="Create Formal Case" ButtonStyle="ButtonStyle.Success" Click="CreateNewCase" />
                    <RadzenButton Icon="refresh" Text="Refresh List" ButtonStyle="ButtonStyle.Light" Click="LoadAllCases" />
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <RadzenCard Variant="Variant.Outlined">
            <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H2" class="rz-mb-3">
                <RadzenIcon Icon="list" /> All Formal Cases
            </RadzenText>
            
            <RadzenDataGrid @ref="casesGrid" Data="@allCases" TItem="FormalLineOfDuty" 
                           AllowFiltering="true" AllowSorting="true" AllowPaging="true" PageSize="10"
                           FilterMode="FilterMode.Simple" SelectionMode="DataGridSelectionMode.Single"
                           @bind-Value="@selectedCases" RowSelect="OnCaseSelected"
                           EmptyText="No formal cases found. Create a new formal case to get started.">
                <Columns>
                    <RadzenDataGridColumn TItem="FormalLineOfDuty" Property="CaseNumber" Title="Case Number" Width="180px">
                        <Template Context="lodCase">
                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@lodCase.CaseNumber" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="FormalLineOfDuty" Property="MemberName" Title="Member" Width="200px" />
                    <RadzenDataGridColumn TItem="FormalLineOfDuty" Property="MemberId" Title="Member ID" Width="150px" />
                    <RadzenDataGridColumn TItem="FormalLineOfDuty" Property="CurrentState" Title="Current State" Width="180px">
                        <Template Context="lodCase">
                            <RadzenBadge BadgeStyle="@GetStateBadgeStyle(lodCase.CurrentState)" Text="@lodCase.CurrentState.ToString()" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="FormalLineOfDuty" Property="IsDeathCase" Title="Death Case" Width="100px">
                        <Template Context="lodCase">
                            @if (lodCase.IsDeathCase)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Yes" />
                            }
                            else
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="No" />
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="FormalLineOfDuty" Property="CreatedDate" Title="Created" Width="150px" FormatString="{0:d}" />
                    <RadzenDataGridColumn TItem="FormalLineOfDuty" Property="LastModifiedDate" Title="Last Modified" Width="150px" FormatString="{0:d}" />
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>

        @if (selectedCase != null)
        {
            <RadzenCard Variant="Variant.Outlined">
                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" class="rz-mb-0">
                            Case Details: @selectedCase.CaseNumber
                        </RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            @if (selectedCase.IsDeathCase)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Death Case" Style="font-size: 0.9rem; padding: 0.4rem 0.8rem;" />
                            }
                            <RadzenBadge BadgeStyle="@GetStateBadgeStyle(selectedCase.CurrentState)" 
                                        Text="@selectedCase.CurrentState.ToString()" 
                                        Style="font-size: 1rem; padding: 0.5rem 1rem;" />
                        </RadzenStack>
                    </RadzenStack>

                    <RadzenTabs>
                        <Tabs>
                            <RadzenTabsItem Text="Case Information" Icon="info">
                                <RadzenCard class="rz-mt-3">
                                    <RadzenRow Gap="1rem">
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Overline">Member Name</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">@selectedCase.MemberName</RadzenText>
                                            
                                            <RadzenText TextStyle="TextStyle.Overline">Member ID</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">@selectedCase.MemberId</RadzenText>
                                            
                                            <RadzenText TextStyle="TextStyle.Overline">Investigating Officer</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">
                                                @(string.IsNullOrEmpty(selectedCase.InvestigatingOfficerName) ? "Not assigned" : selectedCase.InvestigatingOfficerName)
                                            </RadzenText>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Overline">Created Date</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">@selectedCase.CreatedDate.ToString("f")</RadzenText>
                                            
                                            <RadzenText TextStyle="TextStyle.Overline">Last Modified</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">@selectedCase.LastModifiedDate.ToString("f")</RadzenText>
                                            
                                            <RadzenText TextStyle="TextStyle.Overline">Death Case</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">
                                                @if (selectedCase.IsDeathCase)
                                                {
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Yes - Expedited Processing Required" />
                                                }
                                                else
                                                {
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="No" />
                                                }
                                            </RadzenText>
                                        </RadzenColumn>
                                    </RadzenRow>
                                    
                                    <RadzenText TextStyle="TextStyle.H6" class="rz-mt-4 rz-mb-2">Case Flags</RadzenText>
                                    <RadzenRow Gap="1rem">
                                        <RadzenColumn Size="6" SizeMD="3">
                                            <RadzenCard Variant="Variant.Filled">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenIcon Icon="@(selectedCase.ToxicologyRequired ? "check_circle" : "cancel")" 
                                                               IconStyle="@(selectedCase.ToxicologyRequired ? IconStyle.Success : IconStyle.Light)" />
                                                    <RadzenStack Gap="0">
                                                        <RadzenText TextStyle="TextStyle.Caption">Toxicology</RadzenText>
                                                        <RadzenText TextStyle="TextStyle.Subtitle2">@(selectedCase.ToxicologyRequired ? "Required" : "Not Required")</RadzenText>
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenCard>
                                        </RadzenColumn>
                                        <RadzenColumn Size="6" SizeMD="3">
                                            <RadzenCard Variant="Variant.Filled">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenIcon Icon="@(selectedCase.ToxicologyComplete ? "check_circle" : "pending")" 
                                                               IconStyle="@(selectedCase.ToxicologyComplete ? IconStyle.Success : IconStyle.Warning)" />
                                                    <RadzenStack Gap="0">
                                                        <RadzenText TextStyle="TextStyle.Caption">Toxicology</RadzenText>
                                                        <RadzenText TextStyle="TextStyle.Subtitle2">@(selectedCase.ToxicologyComplete ? "Complete" : "Pending")</RadzenText>
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenCard>
                                        </RadzenColumn>
                                        <RadzenColumn Size="6" SizeMD="3">
                                            <RadzenCard Variant="Variant.Filled">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenIcon Icon="@(selectedCase.AppealFiled ? "gavel" : "remove_circle")" 
                                                               IconStyle="@(selectedCase.AppealFiled ? IconStyle.Danger : IconStyle.Light)" />
                                                    <RadzenStack Gap="0">
                                                        <RadzenText TextStyle="TextStyle.Caption">Appeal</RadzenText>
                                                        <RadzenText TextStyle="TextStyle.Subtitle2">@(selectedCase.AppealFiled ? "Filed" : "Not Filed")</RadzenText>
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenCard>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenCard>
                            </RadzenTabsItem>

                            <RadzenTabsItem Text="Available Actions" Icon="play_arrow">
                                <RadzenCard class="rz-mt-3">
                                    @if (permittedTriggers.Any())
                                    {
                                        <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-3">
                                            The following actions are available in the current state:
                                        </RadzenText>
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                                            @foreach (var trigger in permittedTriggers)
                                            {
                                                <RadzenButton Icon="send" Text="@trigger" 
                                                            ButtonStyle="ButtonStyle.Primary" 
                                                            Click="() => ShowTriggerConfirmation(trigger)" />
                                            }
                                        </RadzenStack>
                                    }
                                    else
                                    {
                                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                                            <RadzenIcon Icon="info" /> No actions available in the current state.
                                        </RadzenAlert>
                                    }
                                </RadzenCard>
                            </RadzenTabsItem>

                            <RadzenTabsItem Text="Transition History" Icon="history">
                                <RadzenCard class="rz-mt-3">
                                    @if (caseHistory.Any())
                                    {
                                        <RadzenDataGrid Data="@caseHistory.OrderByDescending(t => t.Timestamp)" TItem="FormalStateTransitionHistory" 
                                                       AllowSorting="true" AllowPaging="true" PageSize="10">
                                            <Columns>
                                                <RadzenDataGridColumn TItem="FormalStateTransitionHistory" Property="FromState" Title="From State" Width="150px">
                                                    <Template Context="transition">
                                                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@transition.FromState.ToString()" />
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="FormalStateTransitionHistory" Property="ToState" Title="To State" Width="150px">
                                                    <Template Context="transition">
                                                        <RadzenBadge BadgeStyle="@GetStateBadgeStyle(transition.ToState)" Text="@transition.ToState.ToString()" />
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="FormalStateTransitionHistory" Property="Trigger" Title="Trigger" Width="150px">
                                                    <Template Context="transition">
                                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@transition.Trigger.ToString()" />
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="FormalStateTransitionHistory" Property="PerformedByAuthority" Title="Authority" Width="150px" />
                                                <RadzenDataGridColumn TItem="FormalStateTransitionHistory" Property="Timestamp" Title="Timestamp" FormatString="{0:g}" />
                                                <RadzenDataGridColumn TItem="FormalStateTransitionHistory" Property="Notes" Title="Notes" />
                                            </Columns>
                                        </RadzenDataGrid>
                                    }
                                    else
                                    {
                                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                                            <RadzenIcon Icon="info" /> No transition history available for this case.
                                        </RadzenAlert>
                                    }
                                </RadzenCard>
                            </RadzenTabsItem>
                        </Tabs>
                    </RadzenTabs>
                </RadzenStack>
            </RadzenCard>
        }
    }
</RadzenStack>
